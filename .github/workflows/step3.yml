name: CI Pipeline - Step 3

on:
  workflow_dispatch
  # workflow_run:
  #   workflows: 
  #     - "CI Pipeline - Step 1"
  #     - "CI Pipeline - Step 2"
  #   types:
  #     - completed
  

jobs:
  get-git-branch-value:
    runs-on: ubuntu-latest
    steps:
      - name: Get the latest run_id of Step 1 workflow
        id: get_run_id_step_1
        run: |
          workflow_name="step1.yml"  # Name of the workflow
          repo_name="${{ github.repository }}"
          api_url="https://api.github.com/repos/$repo_owner/$repo_name/actions/workflows"
          echo "API URL: $api_url"
  
          # Call the GitHub API to list workflow runs by workflow name
          response=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GIT_TOKEN}}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$repo_name/actions/workflows/$workflow_name/runs?per_page=1)
  
          # Extract the run_id of the latest workflow run
          run_id=$(echo "$response" | jq -r '.workflow_runs[0].id')
  
          echo "Latest run_id is: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT
  
      - name: Use the run_id
        run: |
          echo "The run_id of the latest workflow is: ${{ steps.get_run_id_step_1.outputs.run_id }}"

      - name: Download github_branch
        uses: actions/download-artifact@v4
        with:
          name: github_branch
          github-token : ${{ secrets.GIT_TOKEN}}
          repository : ${{ github.repository }}
          run-id : ${{ steps.get_run_id_step_1.outputs.run_id }}
          
      - name: Store artifacts Value
        run: |
           branch_value=$(cat github_branch)
           echo "branch_value=${branch_value}"
           echo "branch=${branch_value}" >> $GITHUB_OUTPUT
      
  get-tdv-env-value:
    runs-on: ubuntu-latest
    steps:
      - name: Get the latest run_id of Step 2 workflow
        id: get_run_id_step_2
        run: |
          workflow_name="step2.yml"  # Name of the workflow
          repo_name="${{ github.repository }}"
          api_url="https://api.github.com/repos/$repo_owner/$repo_name/actions/workflows"
          echo "API URL: $api_url"
  
          # Call the GitHub API to list workflow runs by workflow name
          response=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GIT_TOKEN}}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$repo_name/actions/workflows/$workflow_name/runs?per_page=1)
  
          # Extract the run_id of the latest workflow run
          run_id=$(echo "$response" | jq -r '.workflow_runs[0].id')
  
          echo "Latest run_id is: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT
  
      - name: Use the run_id
        run: |
          echo "The run_id of the latest workflow is: ${{ steps.get_run_id_step_2.outputs.run_id }}"

      - name: Download tdv_env
        uses: actions/download-artifact@v4
        with:
          name: tdv_env
          github-token : ${{ secrets.GIT_TOKEN}}
          repository : ${{ github.repository }}
          run-id : ${{ steps.get_run_id_step_2.outputs.run_id }}
          
      - name: Store artifacts Value
        run: |
           branch_value=$(cat tdv_env)
           echo "branch_value=${branch_value}"
           echo "branch=${branch_value}" >> $GITHUB_OUTPUT
